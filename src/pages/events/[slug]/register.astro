---
// /events/[slug]/register.astro - Dynamic Registration Page
import MainLayout from '../../../layouts/MainLayout.astro';
import { events } from '../../../data/events';
import { Icon } from 'astro-icon/components';

export async function getStaticPaths() {
  return events
    .filter(event => event.status === 'upcoming' && event.registrationLink) // Only generate for upcoming events with links
    .map((event) => ({
      params: { slug: event.slug },
      props: { event },
    }));
}

const { event } = Astro.props;

// Logic moved from previous DevthonRegistration.astro
// Assuming a generic registration form component or structure here.
// For now, I will create a robust, generic registration form that adapts to the event.

---

<MainLayout 
  title={`Register for ${event.title} | DevUp Society`}
  description={`Secure your spot for ${event.title}. Limited seats available.`}
>
  <div class="min-h-screen bg-[#030303] flex items-center justify-center p-6 relative overflow-hidden">
    <!-- Background FX -->
    <div class="fixed inset-0 pointer-events-none">
      <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_50%_0%,rgba(204,255,0,0.05),transparent_70%)]"></div>
      <div class="grid-floor opacity-20"></div>
    </div>

    <div class="relative z-10 w-full max-w-2xl">
      <!-- Header -->
      <div class="text-center mb-10">
        <a href={`/events/${event.slug}`} class="inline-flex items-center gap-2 text-zinc-500 hover:text-white font-mono text-xs uppercase tracking-widest transition-colors mb-6">
          <Icon name="lucide:arrow-left" />
          <span>Back to Event details</span>
        </a>
        <h1 class="font-display text-4xl md:text-5xl text-white font-bold mb-4">
          REGISTER NOW
        </h1>
        <p class="font-mono text-zinc-400 text-sm">
          Event: <span class="text-signal">{event.title}</span>
        </p>
        {event.fee && (
            <div class="mt-4 inline-block px-4 py-1 bg-zinc-900 border border-zinc-800 rounded-full">
                <span class="font-mono text-xs text-zinc-400">Registration Fee: <span class="text-white font-bold">₹{event.fee}/person</span></span>
            </div>
        )}
      </div>

      <!-- Form Container -->
      <div class="glass-panel p-8 md:p-12 clip-corner relative overflow-hidden">
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex-col items-center justify-center">
            <div class="w-16 h-16 border-2 border-zinc-800 border-t-signal rounded-full animate-spin mb-4"></div>
            <span class="font-mono text-signal text-xs animate-pulse">PROCESSING REGISTRATION...</span>
        </div>

        <!-- Success Message -->
        <div id="success-screen" class="hidden text-center py-10">
            <div class="w-20 h-20 bg-signal/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-signal/20">
                <Icon name="lucide:check" class="text-4xl text-signal" />
            </div>
            <h2 class="font-display text-3xl text-white mb-4">REGISTRATION RECEIVED</h2>
            <p class="font-mono text-zinc-400 text-sm mb-8">
                We are verifying your payment. You will receive confirmation at <span id="success-email" class="text-white"></span>.
                For queries, reach us at <a href="mailto:devupsociety@vjit.ac.in" class="text-signal hover:underline">devupsociety@vjit.ac.in</a>.
            </p>
            <div class="glass-panel p-6 clip-corner text-left max-w-xl mx-auto mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs font-mono text-zinc-400">
                    <div>
                        <div class="text-zinc-500 uppercase tracking-widest">Team Number</div>
                        <div id="success-team-number" class="text-white text-sm"></div>
                    </div>
                    <div>
                        <div class="text-zinc-500 uppercase tracking-widest">Team Name</div>
                        <div id="success-team-name" class="text-white text-sm"></div>
                    </div>
                    <div>
                        <div class="text-zinc-500 uppercase tracking-widest">Lead</div>
                        <div id="success-lead-name" class="text-white text-sm"></div>
                    </div>
                    <div>
                        <div class="text-zinc-500 uppercase tracking-widest">Team Size</div>
                        <div id="success-team-size" class="text-white text-sm"></div>
                    </div>
                    <div>
                        <div class="text-zinc-500 uppercase tracking-widest">Amount</div>
                        <div id="success-amount" class="text-white text-sm"></div>
                    </div>
                    <div>
                        <div class="text-zinc-500 uppercase tracking-widest">Transaction ID</div>
                        <div id="success-transaction" class="text-white text-sm"></div>
                    </div>
                </div>
                <div class="mt-4 text-[10px] text-zinc-500 font-mono uppercase tracking-widest">
                    Status: Payment verification pending
                </div>
            </div>
            <a href="/events" class="inline-flex items-center gap-2 px-6 py-3 bg-zinc-800 hover:bg-zinc-700 text-white font-mono text-xs uppercase tracking-widest transition-colors">
                Return to Events
            </a>
        </div>

        <!-- The Form -->
        <form id="registration-form" class="space-y-8" data-event-fee={event.fee ?? 0}>
            <input type="hidden" name="event_slug" value={event.slug} />
            <input type="hidden" name="event_name" value={event.title} />
            <input type="hidden" name="team_number" id="team-number" />
            <input type="hidden" name="payment_amount" id="payment-amount" />

             {/* Team Details Section */}
             <div class="space-y-6">
                <div class="flex items-center gap-3 border-b border-zinc-800 pb-2">
                    <span class="w-6 h-6 rounded-full bg-signal text-black flex items-center justify-center font-bold text-xs">1</span>
                    <h3 class="font-display text-xl text-white">Team Details</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="font-mono text-xs text-zinc-500 uppercase">Team Name</label>
                        <input type="text" name="team_name" required class="w-full bg-black/50 border border-zinc-800 focus:border-signal text-white px-4 py-3 outline-none transition-colors" placeholder="e.g. Code Blasters" />
                    </div>
                    
                    {/* Team Size Counter */}
                     <div class="space-y-2">
                        <label class="font-mono text-xs text-zinc-500 uppercase">Team Size</label>
                        <div class="flex items-center gap-4">
                            <button type="button" id="decrease-size" class="w-12 h-12 bg-zinc-900 border border-zinc-800 hover:border-signal text-white font-mono text-xl flex items-center justify-center transition-colors clip-corner">-</button>
                            <input type="text" id="team-size-display" name="team_size" value="2" readonly class="w-16 h-12 bg-black/50 border border-zinc-800 text-white font-mono text-xl text-center outline-none" />
                            <button type="button" id="increase-size" class="w-12 h-12 bg-zinc-900 border border-zinc-800 hover:border-signal text-white font-mono text-xl flex items-center justify-center transition-colors clip-corner">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="flex items-center gap-3 border-b border-zinc-800 pb-2">
                    <span class="w-6 h-6 rounded-full bg-zinc-800 text-zinc-400 flex items-center justify-center font-bold text-xs">2</span>
                    <h3 class="font-display text-xl text-white">Team Lead (You)</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="font-mono text-xs text-zinc-500 uppercase">Full Name</label>
                        <input type="text" name="lead_name" required class="w-full bg-black/50 border border-zinc-800 focus:border-signal text-white px-4 py-3 outline-none transition-colors" />
                    </div>
                    <div class="space-y-2">
                        <label class="font-mono text-xs text-zinc-500 uppercase">Email (College ID)</label>
                        <input type="email" name="lead_email" required class="w-full bg-black/50 border border-zinc-800 focus:border-signal text-white px-4 py-3 outline-none transition-colors" />
                    </div>
                    <div class="space-y-2">
                        <label class="font-mono text-xs text-zinc-500 uppercase">Phone Number</label>
                        <input type="tel" name="lead_phone" required class="w-full bg-black/50 border border-zinc-800 focus:border-signal text-white px-4 py-3 outline-none transition-colors" />
                    </div>
                    <div class="space-y-2">
                        <label class="font-mono text-xs text-zinc-500 uppercase">College Name</label>
                        <input type="text" name="lead_college" required class="w-full bg-black/50 border border-zinc-800 focus:border-signal text-white px-4 py-3 outline-none transition-colors" />
                    </div>
                </div>
            </div>

            {/* Member 2, 3, 4 Containers (Toggled via JS) */}
            <div id="members-container" class="space-y-6">
                 {/* Populated by JS */}
            </div>


            {/* Payment Section (if fee exists) */}
            {event.fee && event.fee > 0 && (
                <div class="space-y-6">
                    <div class="flex items-center gap-3 border-b border-zinc-800 pb-2">
                        <span class="w-6 h-6 rounded-full bg-zinc-800 text-zinc-400 flex items-center justify-center font-bold text-xs">3</span>
                        <h3 class="font-display text-xl text-white">Payment</h3>
                    </div>
                    
                    <div class="bg-zinc-900/50 p-6 border border-zinc-800 flex flex-col items-center text-center">
                        <p class="font-mono text-xs text-zinc-400 mb-2">Pay to DevUp Society</p>
                        <p class="font-mono text-[10px] text-zinc-500 mb-6">
                            UPI ID: <span id="upi-id" class="text-white"></span> • Note: <span id="upi-note" class="text-white"></span>
                        </p>

                        <div id="upi-mobile" class="hidden w-full">
                            <button type="button" id="upi-open" class="w-full py-3 bg-signal text-black font-mono font-bold uppercase tracking-widest hover:bg-white transition-colors btn-glitch">
                                Open UPI App to Pay
                            </button>
                            <p class="font-mono text-[10px] text-zinc-500 mt-3">
                                After paying, come back and enter your Transaction ID (UTR).
                            </p>
                        </div>

                        <div id="upi-desktop" class="hidden">
                            <p class="font-mono text-xs text-zinc-400 mb-4">Scan QR to Pay</p>
                            <div class="w-48 h-48 bg-white p-2 mb-4">
                                <img src="" alt="Payment QR" class="w-full h-full object-contain" id="payment-qr" />
                            </div>
                        </div>

                        <p class="font-mono text-xl text-white mb-2" id="total-amount">Total: ₹{event.fee * 2}</p>
                        <p class="font-mono text-[10px] text-zinc-500 max-w-xs mx-auto">
                            After payment, please enter the Transaction ID (UTR) below for verification.
                        </p>

                        <div class="w-full mt-6">
                            <label class="font-mono text-xs text-zinc-500 uppercase block text-left mb-2">Transaction ID (UTR)</label>
                            <input type="text" name="transaction_id" required placeholder="e.g. 403212345678" class="w-full bg-black/50 border border-zinc-800 focus:border-signal text-white px-4 py-3 outline-none transition-colors text-center font-mono tracking-widest" />
                        </div>
                    </div>
                </div>
            )}

            <button type="submit" class="w-full py-4 bg-signal text-black font-mono font-bold uppercase tracking-widest hover:bg-white transition-colors btn-glitch">
                Submit Registration
            </button>

        </form>

      </div>
    </div>
  </div>
</MainLayout>

<script>
// ============================================
// PRODUCTION-READY REGISTRATION CLIENT
// With comprehensive error handling and debugging
// ============================================

// Configuration
const BACKEND_URL = 'https://devup-society-website.onrender.com';
const UPI_ID = 'aliffaizan1212@oksbi';
const UPI_PAYEE = 'DevUp Society';

// Logger
const logger = {
  info: (msg, data = {}) => console.log(`[INFO] ${new Date().toISOString()} - ${msg}`, data),
  error: (msg, err = {}) => console.error(`[ERROR] ${new Date().toISOString()} - ${msg}`, err),
  debug: (msg, data = {}) => console.log(`[DEBUG] ${new Date().toISOString()} - ${msg}`, data)
};

// API Functions
async function fetchWithRetry(url, options = {}, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      logger.debug(`Fetch attempt ${i + 1}/${retries}`, { url });
      const response = await fetch(url, options);
      logger.debug('Response received', { status: response.status, url });
      return response;
    } catch (error) {
      logger.error(`Fetch attempt ${i + 1} failed`, { url, error });
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}

async function getNextTeamNumber(slug) {
  try {
    const url = `${BACKEND_URL}/api/get-team-number?slug=${encodeURIComponent(slug)}`;
    const response = await fetchWithRetry(url);
    if (!response.ok) throw new Error('Failed to fetch team number');
    const data = await response.json();
    logger.info('Team number received', { teamNumber: data.teamNumber });
    return data.teamNumber || 'DEV2026-001';
  } catch (error) {
    logger.error('Error fetching team number', error);
    return 'DEV2026-001';
  }
}

async function submitRegistration(formData) {
  try {
    const url = `${BACKEND_URL}/api/register`;
    const response = await fetchWithRetry(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.error || 'Registration failed');
    }
    
    logger.info('Registration successful', { registrationId: data.registrationId });
    return data;
  } catch (error) {
    logger.error('Registration failed', error);
    throw error;
  }
}

// Validation Functions
function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function validatePhone(phone) {
  const clean = phone.replace(/[\s\-\(\)]/g, '');
  return /^[0-9]{10}$/.test(clean);
}

function validateFormData(data) {
  const errors = [];
  if (!data.team_name?.trim()) errors.push('Team name is required');
  if (!data.lead_name?.trim()) errors.push('Lead name is required');
  if (!data.lead_email?.trim()) errors.push('Lead email is required');
  else if (!validateEmail(data.lead_email)) errors.push('Lead email is invalid');
  if (!data.lead_phone?.trim()) errors.push('Lead phone is required');
  else if (!validatePhone(data.lead_phone)) errors.push('Lead phone must be 10 digits');
  if (!data.lead_college?.trim()) errors.push('College name is required');
  if (data.team_size < 2 || data.team_size > 4) errors.push('Team size must be 2-4');
  
  data.members.forEach((m, i) => {
    if (!m.name?.trim()) errors.push(`Member ${i + 2} name is required`);
    if (!m.email?.trim()) errors.push(`Member ${i + 2} email is required`);
    else if (!validateEmail(m.email)) errors.push(`Member ${i + 2} email is invalid`);
    if (!m.phone?.trim()) errors.push(`Member ${i + 2} phone is required`);
    else if (!validatePhone(m.phone)) errors.push(`Member ${i + 2} phone is invalid`);
  });
  
  if (data.payment_amount > 0 && !data.transaction_id?.trim()) {
    errors.push('Transaction ID is required');
  }
  
  return { valid: errors.length === 0, errors };
}

// Payment Functions
function buildUpiLink(amount, teamNumber) {
  const params = new URLSearchParams({
    pa: UPI_ID,
    pn: UPI_PAYEE,
    am: amount.toString(),
    cu: 'INR',
    tn: teamNumber
  });
  return `upi://pay?${params.toString()}`;
}

function getQRCodeUrl(upiLink) {
  return `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(upiLink)}`;
}

function isMobileDevice() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', async () => {
  logger.info('Registration page loaded - initializing');
  
  try {
    // ============================================
    // DOM ELEMENT REFERENCES
    // ============================================
    const form = document.getElementById('registration-form');
    const teamSizeInput = document.getElementById('team-size-display');
    const increaseBtn = document.getElementById('increase-size');
    const decreaseBtn = document.getElementById('decrease-size');
    const membersContainer = document.getElementById('members-container');
    const qrImage = document.getElementById('payment-qr');
    const totalAmountDisplay = document.getElementById('total-amount');
    const upiOpenButton = document.getElementById('upi-open');
    const upiMobile = document.getElementById('upi-mobile');
    const upiDesktop = document.getElementById('upi-desktop');
    const upiIdDisplay = document.getElementById('upi-id');
    const upiNoteDisplay = document.getElementById('upi-note');
    const teamNumberInput = document.getElementById('team-number');
    const paymentAmountInput = document.getElementById('payment-amount');
    const loadingOverlay = document.getElementById('loading-overlay');
    const successScreen = document.getElementById('success-screen');

    if (!form) {
      logger.error('Registration form element not found');
      return;
    }

    // Get event fee from form data attribute
    const eventFeeRaw = form.dataset.eventFee || '0';
    const eventFee = parseInt(eventFeeRaw);
    logger.info('Event fee loaded', { eventFee });

    // ============================================
    // PAYMENT UI UPDATE
    // ============================================
    function updatePaymentUI(total, teamNumber) {
      logger.debug('Updating payment UI', { total, teamNumber });
      
      const upiLink = buildUpiLink(total, teamNumber);

      if (upiIdDisplay) upiIdDisplay.textContent = UPI_ID;
      if (upiNoteDisplay) upiNoteDisplay.textContent = teamNumber;
      if (paymentAmountInput) paymentAmountInput.value = total.toString();

      if (qrImage) {
        qrImage.src = getQRCodeUrl(upiLink);
        logger.debug('QR code URL set', { url: qrImage.src });
      }

      if (upiOpenButton) {
        upiOpenButton.onclick = () => {
          logger.info('Opening UPI app', { upiLink });
          window.location.href = upiLink;
        };
      }

      if (upiMobile && upiDesktop) {
        const mobile = isMobileDevice();
        logger.debug('Device type detected', { mobile });
        upiMobile.classList.toggle('hidden', !mobile);
        upiDesktop.classList.toggle('hidden', mobile);
      }
    }

    // ============================================
    // MEMBER FIELDS RENDERING
    // ============================================
    function updateMemberFields() {
      if (!membersContainer || !teamSizeInput) return;
      
      let size = parseInt(teamSizeInput.value) || 2;
      if (size < 2) size = 2;
      if (size > 4) size = 4;

      logger.debug('Updating member fields', { teamSize: size });
      membersContainer.innerHTML = '';

      // Create fields for Member 2 to Size
      for (let i = 2; i <= size; i++) {
        const memberHtml = `
          <div class="space-y-6 pt-6 border-t border-zinc-900">
            <div class="flex items-center gap-3 mb-2">
              <span class="font-mono text-[10px] bg-zinc-900 text-signal px-2 py-1 rounded border border-zinc-800 uppercase tracking-widest">
                // Member 0${i}
              </span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input type="text" name="member_${i}_name" required placeholder="Name" class="w-full bg-black/50 border border-zinc-800 focus:border-signal text-white px-4 py-3 outline-none transition-colors text-sm" />
              <input type="email" name="member_${i}_email" required placeholder="Email" class="w-full bg-black/50 border border-zinc-800 focus:border-signal text-white px-4 py-3 outline-none transition-colors text-sm" />
              <input type="tel" name="member_${i}_phone" required placeholder="Phone Number" class="w-full bg-black/50 border border-zinc-800 focus:border-signal text-white px-4 py-3 outline-none transition-colors text-sm" />
            </div>
          </div>
        `;
        membersContainer.insertAdjacentHTML('beforeend', memberHtml);
      }

      // Update Payment Info
      if (eventFee > 0 && totalAmountDisplay && teamNumberInput) {
        const total = eventFee * size;
        totalAmountDisplay.textContent = `Total: ₹${total}`;
        updatePaymentUI(total, teamNumberInput.value || 'DEV2026-000');
      }
      
      logger.debug('Member fields updated', { count: size - 1 });
    }

    // ============================================
    // TEAM SIZE CONTROLS
    // ============================================
    function initTeamControls() {
      if (increaseBtn && decreaseBtn && teamSizeInput) {
        increaseBtn.addEventListener('click', () => {
          let current = parseInt(teamSizeInput.value) || 2;
          if (current < 4) {
            teamSizeInput.value = (current + 1).toString();
            logger.info('Team size increased', { newSize: current + 1 });
            updateMemberFields();
          }
        });

        decreaseBtn.addEventListener('click', () => {
          let current = parseInt(teamSizeInput.value) || 2;
          if (current > 2) {
            teamSizeInput.value = (current - 1).toString();
            logger.info('Team size decreased', { newSize: current - 1 });
            updateMemberFields();
          }
        });
        
        logger.debug('Team controls initialized');
      }
    }

    // ============================================
    // TEAM NUMBER INITIALIZATION
    // ============================================
    async function initTeamNumber() {
      if (!teamNumberInput) return;
      
      const slugInput = document.querySelector('input[name="event_slug"]');
      const slug = slugInput?.value || 'event';
      
      logger.info('Fetching team number', { slug });
      
      try {
        const teamNumber = await getNextTeamNumber(slug);
        teamNumberInput.value = teamNumber;
        logger.info('Team number initialized', { teamNumber });
        updateMemberFields();
      } catch (error) {
        logger.error('Failed to initialize team number', error);
        teamNumberInput.value = 'DEV2026-001';
        updateMemberFields();
      }
    }

    // ============================================
    // FORM SUBMISSION
    // ============================================
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      logger.info('Form submission started');
      
      if (!successScreen || !loadingOverlay) {
        logger.error('Success screen or loading overlay not found');
        alert('ERROR: Missing UI elements. Check console.');
        return;
      }

      // Show loading
      loadingOverlay.classList.remove('hidden');
      loadingOverlay.classList.add('flex');
      logger.debug('Loading overlay shown');
      
      try {
        // Extract form data
        const formData = new FormData(form);
        const teamSize = parseInt(teamSizeInput?.value || '2');
        
        logger.debug('Extracting form data...', { teamSize });
        
        // Build members array
        const members = [];
        for (let i = 2; i <= teamSize; i++) {
          const name = formData.get(`member_${i}_name`);
          const email = formData.get(`member_${i}_email`);
          const phone = formData.get(`member_${i}_phone`);
          if (name || email || phone) {
            members.push({ name, email, phone });
          }
        }
        
        const registrationData = {
          event_slug: formData.get('event_slug'),
          event_name: formData.get('event_name'),
          team_name: formData.get('team_name'),
          lead_name: formData.get('lead_name'),
          lead_email: formData.get('lead_email'),
          lead_phone: formData.get('lead_phone'),
          lead_college: formData.get('lead_college'),
          team_number: formData.get('team_number'),
          team_size: teamSize,
          payment_amount: parseInt(formData.get('payment_amount')) || 0,
          transaction_id: formData.get('transaction_id') || undefined,
          members
        };
        
        logger.info('Form data extracted successfully', { 
          teamName: registrationData.team_name,
          teamNumber: registrationData.team_number,
          teamSize: registrationData.team_size,
          memberCount: members.length
        });

        // Validate form data
        logger.debug('Validating form data...');
        const validation = validateFormData(registrationData);
        
        if (!validation.valid) {
          logger.error('Form validation failed', { errors: validation.errors });
          loadingOverlay.classList.add('hidden');
          loadingOverlay.classList.remove('flex');
          alert('Please fix the following errors:\n\n' + validation.errors.map(e => `• ${e}`).join('\n'));
          return;
        }

        logger.info('Form validation passed - submitting to backend...');

        // Submit registration
        const result = await submitRegistration(registrationData);

        logger.info('✅ Registration API call successful!', { 
          registrationId: result.registrationId,
          teamNumber: result.teamNumber
        });

        // Success!
        logger.info('Showing success screen in 1 second...');
        
        setTimeout(() => {
          loadingOverlay.classList.add('hidden');
          loadingOverlay.classList.remove('flex');
          form.classList.add('hidden');
          successScreen.classList.remove('hidden');
          
          logger.debug('Success screen made visible');
          
          // Update success screen with data
          const setTextContent = (id, text) => {
            const el = document.getElementById(id);
            if (el) {
              el.textContent = text;
              logger.debug(`Set ${id} to: ${text}`);
            } else {
              logger.error(`Element not found: ${id}`);
            }
          };
          
          setTextContent('success-team-name', result.teamName || '');
          setTextContent('success-lead-name', result.leadName || '');
          setTextContent('success-team-size', (result.teamSize || 0).toString());
          setTextContent('success-team-number', result.teamNumber || '');
          setTextContent('success-amount', `₹${result.paymentAmount || 0}`);
          setTextContent('success-transaction', result.transactionId || '-');
          setTextContent('success-email', result.leadEmail || '');
          
          logger.info('✅ SUCCESS SCREEN DISPLAYED');
        }, 1000);

      } catch (error) {
        logger.error('❌ Registration submission failed', error);
        logger.error('Error details:', {
          message: error.message,
          stack: error.stack
        });
        
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
        
        const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';
        alert(`Registration failed: ${errorMessage}\n\nCheck console (F12) for details.`);
      }
    });

    // ============================================
    // INITIALIZATION
    // ============================================
    logger.info('Initializing registration form');
    initTeamControls();
    await initTeamNumber();
    
    logger.info('Registration page fully initialized and ready');

  } catch (error) {
    logger.error('Critical error during initialization', error);
    alert('Failed to initialize registration form. Please refresh the page.');
  }
});
</script>
